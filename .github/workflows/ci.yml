name: CI

on:
  pull_request:
    branches: [main]
  schedule:
    # First Friday of each month at 18:00 UTC
    - cron: "0 18 1-7 * 5"

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  # Explicit target so RUSTFLAGS don't apply to build scripts/proc-macros
  TARGET: x86_64-unknown-linux-gnu
  # Max seconds for example runs that loop or write forever
  TIMEOUT: 5

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          components: rustfmt
      - run: cargo fmt --check

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-gnu
          components: clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: cargo clippy --all-targets --target $TARGET -- -D warnings
        env:
          RUSTFLAGS: "-C target-feature=+avx2,+avx512f,+avx512dq,+avx512vl"

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: msrv-avx2
            toolchain: "1.89.0"
            rustflags: "-C target-feature=+avx2"
            cargo-args: ""
          - name: stable-avx2
            toolchain: stable
            rustflags: "-C target-feature=+avx2"
            cargo-args: ""
          - name: nightly-portable
            toolchain: nightly
            rustflags: ""
            cargo-args: "--no-default-features --features portable"
    name: test (${{ matrix.name }})
    env:
      CARGO_PROFILE_RELEASE_LTO: "false"
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 16
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ matrix.toolchain }}
          targets: x86_64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - uses: taiki-e/install-action@a362280ea100b5bb920cf9040c038ce9a50c7943 # v2.67.16
        with:
          tool: nextest
      - run: cargo +${{ matrix.toolchain }} nextest run --target $TARGET --release ${{ matrix.cargo-args }}
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}

  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: stable-default
            toolchain: stable
            cargo-args: ""
          - name: nightly-all-features
            toolchain: nightly
            cargo-args: "--all-features"
    name: build (${{ matrix.name }})
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ matrix.toolchain }}
          targets: x86_64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: cargo +${{ matrix.toolchain }} build --all-targets ${{ matrix.cargo-args }} --target $TARGET
        env:
          RUSTFLAGS: "-C target-feature=+avx2,+avx512f,+avx512dq,+avx512vl"

  examples:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          targets: x86_64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: cargo +nightly build --examples --release --features portable,specific --target $TARGET
        env:
          RUSTFLAGS: "-C target-feature=+avx2"
      - run: timeout $TIMEOUT cargo +nightly run --example dasm --release --features portable,specific --target $TARGET || [ $? -eq 124 ]
        env:
          RUSTFLAGS: "-C target-feature=+avx2"
      - run: timeout $TIMEOUT cargo +nightly run --example profile --release --features portable --target $TARGET || [ $? -eq 124 ]
        env:
          RUSTFLAGS: "-C target-feature=+avx2"
      - run: timeout -s KILL $TIMEOUT cargo +nightly run --example practrand --release --features portable --target $TARGET > /dev/null || [ $? -eq 137 ]
        env:
          RUSTFLAGS: "-C target-feature=+avx2"

  bench:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          targets: x86_64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: cargo +nightly build --benches --release --features portable --target $TARGET
        env:
          RUSTFLAGS: "-C target-feature=+avx2"
      - run: cargo +nightly bench --features portable --target $TARGET -- "Top" --warm-up-time 1 --measurement-time 1 --sample-size 10
        env:
          RUSTFLAGS: "-C target-feature=+avx2"

  doc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          targets: x86_64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: cargo +nightly doc --all-features --no-deps --target $TARGET
        env:
          RUSTFLAGS: "-C target-feature=+avx2,+avx512f,+avx512dq,+avx512vl"
          RUSTDOCFLAGS: "--cfg docsrs -C target-feature=+avx2,+avx512f,+avx512dq,+avx512vl"

  test-miri:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          targets: x86_64-unknown-linux-gnu
          components: miri
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: cargo +nightly miri test --target $TARGET --no-default-features --features portable --lib
        env:
          MIRIFLAGS: "-Zmiri-disable-isolation"
